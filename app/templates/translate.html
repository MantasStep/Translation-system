{# templates/translate.html #}
{% extends 'base.html' %}

{% block title %}Teksto ir dokumento vertimas{% endblock %}

{% block head %}
<style>
  .split-view {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
  }
  .split-view > .panel {
    flex: 1;
    border: 1px solid #ddd;
    padding: 1rem;
    border-radius: .5rem;
    background: #fafafa;
  }
  .result-box {
    margin-top: .5rem;
    min-height: 4em;
    background: #fff;
    padding: .75rem;
    border: 1px solid #ccc;
    border-radius: .25rem;
  }
</style>
{% endblock %}

{% block content %}
<h1>Automatinis vertimas</h1>

<div class="split-view mt-4">
  <!-- Teksto vertimo panelė -->
  <div class="panel">
    <h4>Teksto vertimas</h4>
    <form id="text-form">
      <div class="mb-3">
        <label for="text-input" class="form-label">Įveskite tekstą:</label>
        <textarea id="text-input" name="text" class="form-control" rows="5"></textarea>
      </div>
      <div class="mb-3">
        <label for="text-direction" class="form-label">Kryptis:</label>
        <select id="text-direction" name="direction" class="form-select">
          <option value="lt-en">Lietuvių → Anglų</option>
          <option value="en-lt">Anglų → Lietuvių</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Versti tekstą</button>
    </form>
    <div id="text-result" class="result-box"></div>
  </div>

  <!-- Dokumento vertimo panelė -->
  <div class="panel">
    <h4>Dokumento vertimas</h4>
    <form id="file-form" enctype="multipart/form-data">
      <div class="mb-3">
        <label for="file-input" class="form-label">Pasirinkite .docx arba .txt:</label>
        <input id="file-input" name="file" type="file" accept=".docx,.txt" class="form-control">
      </div>
      <div class="mb-3">
        <label for="file-direction" class="form-label">Kryptis:</label>
        <select id="file-direction" name="direction" class="form-select">
          <option value="lt-en">Lietuvių → Anglų</option>
          <option value="en-lt">Anglų → Lietuvių</option>
        </select>
      </div>
      <button type="submit" class="btn btn-secondary">Versti dokumentą</button>
    </form>
    <div id="file-result" class="result-box"></div>
  </div>
</div>

<script>
  // Teksto vertimas
  document.getElementById('text-form').onsubmit = async e => {
    e.preventDefault();
    const data = {
      text: document.getElementById('text-input').value,
      src: document.getElementById('text-direction').value.split('-')[0],
      tgt: document.getElementById('text-direction').value.split('-')[1],
    };
    const res = await fetch('/translate/', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    const json = await res.json();
    // we renamed the API's "all" field to "candidates" for clarity
    const candidates = json.candidates || json.all;
    document.getElementById('text-result').innerHTML =
      `<strong>Geriausias:</strong> ${json.best}
       <hr/><strong>Visi modeliai:</strong><ul>` +
      Object.entries(candidates)
            .map(([m,t])=>`<li>${m}: ${t}</li>`).join('') +
      `</ul>`;
  };

  // Dokumento vertimas
  document.getElementById('file-form').onsubmit = async e => {
    e.preventDefault();
    const form = new FormData();
    form.append('file', document.getElementById('file-input').files[0]);
    form.append('direction', document.getElementById('file-direction').value);

    const res = await fetch('/translate/upload', { method: 'POST', body: form });
    if (!res.ok) {
      document.getElementById('file-result').textContent = 'Klaida vertime.';
      return;
    }
    const disp = res.headers.get('Content-Disposition')||'';
    if (disp.includes('attachment')) {
      const blob = await res.blob();
      const url  = URL.createObjectURL(blob);
      const name = disp.split('filename=')[1]||'translated.docx';
      document.getElementById('file-result').innerHTML =
        `<a href="${url}" download="${name}" class="btn btn-success">
           Atsisiųsti: ${name}
         </a>`;
    } else {
      document.getElementById('file-result').textContent = await res.text();
    }
  };
</script>
{% endblock %}
